################################################################
# $Id: Makefile.in,v 1.3 2001/01/29 03:44:28 frolov Exp $
# Makefile for Scarse source code
################################################################

SHELL = /bin/sh

PREFIX  = /usr/local

BINDIR  = $(PREFIX)/bin
LIBDIR  = $(PREFIX)/lib
DATADIR = $(PREFIX)/share/cms


CC	= gcc
LD	= ld
AR	= ar -r
RANLIB	= ranlib
INSTALL = install

VERSION = $(shell cat ../VERSION)



################################################################
# Configuration
################################################################

# Define if you want debugging code compiled in
DEBUG = 1


# Compiler flags
ifdef DEBUG
CFLAGS	= -m486 -g -pg -Wall
DEFINES	= -DDEBUG -DVERSION='"$(VERSION) (debugging on)"' -DDATADIR='"$(DATADIR)"'
LDFLAGS	= -pg
else
CFLAGS	= -m486 -O6 -fomit-frame-pointer -funroll-loops
DEFINES	= -DVERSION='"$(VERSION)"' -DDATADIR='"$(DATADIR)"'
LDFLAGS	=
endif

INCLUDE	= -I../icclib
LIBS	= -L../icclib -ltiff -licc -lm

ALLFLAGS = $(CFLAGS) $(DEFINES) $(INCLUDE)


ifdef DEBUG
# Define if you want visual data representation using PGPlot
PGPLOT = 1

F77	= f77
PGPDIR	= $(HOME)/local
PGPFLGS	= -DPGPLOT -I$(PGPDIR)/include
PGPLIBS	= -L/usr/X11R6/lib -L$(PGPDIR)/lib -lcpgplot -lpgplot -lX11
endif



################################################################
# Dependencies
################################################################

# Files
hdrs = $(wildcard *.h imageio/*.h)
objs = $(wildcard *.o imageio/*.o *.a)
bins = cmap ipb calibrate


# Targets
.PHONY: all clean distclean install

all: $(bins)

clean:
	rm -f $(objs)

distclean: clean
	rm -f $(bins)

install: $(bins)
	$(INSTALL) -d $(BINDIR)
	$(INSTALL) -s $(bins) $(BINDIR)


# Dependencies
cmap: cmap.o imageio.a util.o

ipb: ipb.o interp.o fit.o sort.o spaces.o matrix.o util.o

calibrate: calibrate.o targets.o imageio.a sort.o spaces.o matrix.o util.o

imageio.a: $(addprefix imageio/, pack.o tiff.o ppm.o imageio.o)
	$(AR) $@ $^
	$(RANLIB) $@



################################################################
# Implicit rules
################################################################

ifdef PGPLOT

# DEBUG/PGPLOT rules
%.o: %.c $(hdrs)
	$(CC) $(ALLFLAGS) $(PGPFLGS) -c $< -o $@

%: %.o
	$(F77) $(LDFLAGS) $^ $(LIBS) $(PGPLIBS) -o $@

else

# Production rules
%.o: %.c $(hdrs)
	$(CC) $(ALLFLAGS) -c $< -o $@

%: %.o
	$(CC) $(LDFLAGS) $^ $(LIBS) -o $@

endif
